name: Crypto News Bot

on:
  schedule:
    - cron: '*/3 * * * *'
  workflow_dispatch:

jobs:
  send_news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run news bot
        env:
          SAFEW_BOT_TOKEN: ${{ secrets.SAFEW_BOT_TOKEN }}
          YOUR_CHAT_ID: ${{ secrets.YOUR_CHAT_ID }}
        run: |
          python << 'EOF'
          import requests
          import os
          from datetime import datetime

          SAFEW_BOT_TOKEN = os.environ.get("SAFEW_BOT_TOKEN")
          YOUR_CHAT_ID = os.environ.get("YOUR_CHAT_ID")

          # å¼€å¯æµ‹è¯•ï¼šä¼šçœŸå‘ä¸€æ¡æµ‹è¯•æ¶ˆæ¯
          ENABLE_TEST_SEND = True

          sent_news = set()

          def get_news():
              try:
                  res = requests.get(
                      "https://api.coingecko.com/api/v3/news",
                      params={"query":"bitcoin cryptocurrency"},
                      timeout=10
                  )
                  return res.json().get("data", [])
              except Exception:
                  return []

          def send_message(msg):
              if not SAFEW_BOT_TOKEN or not YOUR_CHAT_ID:
                  print("æœªé…ç½® TOKEN æˆ– CHAT_ID")
                  return False
              try:
                  url = f"https://api.safew.org/bot{SAFEW_BOT_TOKEN}/sendMessage"
                  requests.post(url, json={
                      "chat_id": YOUR_CHAT_ID,
                      "text": msg
                  }, timeout=10)
                  print("å‘é€æˆåŠŸ")
                  return True
              except Exception as e:
                  print("å‘é€å¤±è´¥:", e)
                  return False

          if __name__ == "__main__":
              # æµ‹è¯•ï¼šçœŸå‘ä¸€æ¡
              if ENABLE_TEST_SEND:
                  test_text = "ðŸ¤– å¸åœˆæ–°é—»æœºå™¨äººæµ‹è¯•æˆåŠŸï¼\nå·²æ­£å¸¸è¿è¡Œï½ž"
                  send_message(test_text)

              # æ­£å¸¸æ–°é—»æŽ¨é€
              all_news = get_news()
              new_news = [n for n in all_news if n.get("id") not in sent_news][:5]

              if new_news:
                  text = f"ðŸ“ˆ BTC&å¸åœˆæœ€æ–°æ–°é—» {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\n"
                  for i, n in enumerate(new_news, 1):
                      title = n.get("title", "æ— æ ‡é¢˜")
                      url = n.get("url", "")
                      text += f"{i}. {title}\n{url}\n\n"
                      sent_news.add(n.get("id"))
                  send_message(text)
          EOF